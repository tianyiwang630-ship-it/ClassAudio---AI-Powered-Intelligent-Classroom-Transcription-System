# 日志系统说明

## 更新时间
2026-01-17

## 概述

为了排查转写停止问题，系统新增了完整的日志记录功能，记录所有关键操作和异常。

## 日志文件位置

所有日志文件保存在 `logs/` 目录:

```
logs/
├── audio_service.log    # 音频服务主日志（服务启动/停止）
├── vad.log             # VAD 语音检测详细日志
└── transcriber.log     # 转写器详细日志
```

## 日志级别

- **INFO**: 正常操作（服务启动、语音检测、转写完成）
- **DEBUG**: 详细调试信息（音频块大小、转写参数）
- **ERROR**: 错误信息（包含完整堆栈跟踪）

## VAD 日志内容

[logs/vad.log](../logs/vad.log) 记录:

1. **语音开始检测**
   ```
   2026-01-17 14:30:15 [INFO] VAD - Speech START detected (speech_ms=300)
   ```

2. **语音结束检测**
   ```
   2026-01-17 14:30:20 [INFO] VAD - Speech END detected (reason=silence, utt_ms=5000, silence_ms=800)
   ```
   - `reason`: 结束原因 (`silence` 静音 / `too_long` 超时)
   - `utt_ms`: 语音持续时间（毫秒）
   - `silence_ms`: 静音持续时间（毫秒）

3. **VAD 异常**
   ```
   2026-01-17 14:30:25 [ERROR] VAD - VAD segmenter error: ...
   (完整堆栈跟踪)
   ```

## Transcriber 日志内容

[logs/transcriber.log](../logs/transcriber.log) 记录:

1. **事件接收**
   ```
   2026-01-17 14:30:15 [INFO] Transcriber - Received START event
   2026-01-17 14:30:16 [DEBUG] Transcriber - START audio size: 12345
   2026-01-17 14:30:16 [DEBUG] Transcriber - CHUNK added, total blocks: 10, total samples: 24000
   ```

2. **Partial 转写**
   ```
   2026-01-17 14:30:17 [DEBUG] Transcriber - Partial decode: audio_tail size=16000, dur=1.00s
   2026-01-17 14:30:17 [DEBUG] Transcriber - Partial text: Hello world...
   ```

3. **Final 转写**
   ```
   2026-01-17 14:30:20 [INFO] Transcriber - Received END event, finalizing...
   2026-01-17 14:30:20 [INFO] Transcriber - Finalizing: audio dur=5.20s, blocks=65
   2026-01-17 14:30:20 [DEBUG] Transcriber - Starting final decode...
   2026-01-17 14:30:21 [INFO] Transcriber - Final text: 'This is the complete sentence' (no_speech=0.012, logprob=-0.234)
   ```

4. **质量检查**
   ```
   # 通过
   2026-01-17 14:30:21 [INFO] Transcriber - Accepted final text: This is the complete sentence

   # 拒绝
   2026-01-17 14:30:22 [DEBUG] Transcriber - Rejected: text too short (2 chars)
   2026-01-17 14:30:23 [DEBUG] Transcriber - Rejected: no_speech_prob too high (0.850)
   2026-01-17 14:30:24 [DEBUG] Transcriber - Rejected: avg_logprob too low (-1.200)
   ```

5. **转写异常**
   ```
   2026-01-17 14:30:25 [ERROR] Transcriber - Transcriber error: CUDA out of memory
   (完整堆栈跟踪)
   ```

## 如何查看日志

### 方法 1: 使用日志查看器（推荐）

```bash
python view_logs.py
```

功能:
- 显示所有日志的最后 20 行
- 实时监控新增日志
- 自动分类显示（按服务）

### 方法 2: 直接查看文件

```bash
# 查看最后 50 行
tail -n 50 logs/transcriber.log

# 实时跟踪
tail -f logs/transcriber.log

# Windows PowerShell
Get-Content logs/transcriber.log -Tail 50
Get-Content logs/transcriber.log -Wait
```

### 方法 3: 使用文本编辑器

直接打开 `logs/*.log` 文件。

## 排查问题流程

### 问题: 转写停止

1. **检查 VAD 日志**
   ```bash
   # 查看是否有 Speech START/END
   grep "Speech" logs/vad.log | tail -n 20

   # 查看 VAD 错误
   grep "ERROR" logs/vad.log
   ```

2. **检查 Transcriber 日志**
   ```bash
   # 查看最后的事件
   grep "Received" logs/transcriber.log | tail -n 20

   # 查看是否有 Finalize
   grep "Finalizing" logs/transcriber.log | tail -n 10

   # 查看错误
   grep "ERROR" logs/transcriber.log
   ```

3. **检查音频流**
   ```bash
   # 查看 CHUNK 是否持续增加
   grep "CHUNK added" logs/transcriber.log | tail -n 10
   ```

### 典型问题模式

#### 模式 1: VAD 检测到语音但转写器没有输出
```
vad.log:
  Speech START detected
  Speech END detected

transcriber.log:
  Received START event
  Received END event
  Finalizing: audio dur=5.20s
  Final text: '...' (no_speech=0.850, ...)
  Rejected: no_speech_prob too high
```
**原因**: 音频被识别为噪音，`no_speech_prob` 过高

#### 模式 2: 转写器收不到事件
```
vad.log:
  (空的或很久没更新)

transcriber.log:
  (空的或很久没更新)
```
**原因**: VAD 线程或音频流可能崩溃了

#### 模式 3: 转写器崩溃
```
transcriber.log:
  Received START event
  ERROR in transcriber: CUDA out of memory
  (堆栈跟踪)
  Received START event  # 自动恢复
```
**原因**: CUDA 内存不足，但已自动恢复

## 日志文件管理

### 清空日志

```bash
# Windows
del logs\*.log

# Linux/Mac
rm logs/*.log
```

### 归档日志

```bash
# 按日期归档
mkdir logs_backup_2026-01-17
move logs\*.log logs_backup_2026-01-17\
```

### 日志大小控制

日志文件会持续增长，建议:
- 定期清理旧日志
- 使用日志轮转（未来可添加）
- 测试完成后删除 DEBUG 级别日志

## 性能影响

- **文件写入**: 异步写入，影响极小
- **控制台输出**: INFO 级别，仅关键操作
- **DEBUG 日志**: 仅写入文件，不影响控制台

**推荐**:
- 正常使用: 保留 INFO 和 ERROR
- 排查问题: 启用 DEBUG（已默认启用）

## 常见问题

### Q: 日志文件太大怎么办？

A:
```bash
# 清空但保留文件
echo. > logs/transcriber.log
```

### Q: 如何禁用日志？

A: 在 [audio_service.py](../src/services/audio_service.py) 的 `setup_logger` 中设置:
```python
logger.setLevel(logging.WARNING)  # 只记录警告和错误
```

### Q: 如何只看错误日志？

A:
```bash
grep "ERROR" logs/*.log
```

---

**更新者**: Claude
**版本**: 1.0
**状态**: ✅ 已部署
