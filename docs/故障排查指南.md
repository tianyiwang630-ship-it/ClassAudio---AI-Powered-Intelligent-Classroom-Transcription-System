# 故障排查指南

本文档整合所有常见问题的排查和解决方案。

---

## 目录

- [转写停止问题](#转写停止问题)
- [连接断开问题](#连接断开问题)
- [专业词汇生成失败](#专业词汇生成失败)
- [代码修改不生效](#代码修改不生效)
- [音频捕获问题](#音频捕获问题)
- [模型加载失败](#模型加载失败)

---

## 转写停止问题

### 症状
- 开始录音后字幕不再更新
- Partial 字幕正常但 Accurate 字幕停止
- VAD 检测正常但不转写

### 排查步骤

1. **查看 Transcriber 日志**
   ```bash
   python view_logs.py
   # 或
   tail -f logs/transcriber.log
   ```

2. **检查错误信息**
   - 查找 `[ERROR]` 行
   - 查找 `TypeError`, `ValueError` 等异常

3. **常见原因**
   - 格式化字符串错误
   - None 值处理错误
   - 队列阻塞

### 解决方案

#### 方案 1：清理缓存
```bash
clear_cache.bat
```
然后重启服务。

#### 方案 2：检查代码
确保 `audio_service.py` 中没有格式化错误：
```python
# 正确
no_speech_str = f"{no_speech_prob:.3f}" if no_speech_prob is not None else "N/A"

# 错误（会导致 TypeError）
f"{no_speech_prob:.3f if no_speech_prob else 'N/A'}"
```

#### 方案 3：重启服务
```bash
# 停止
Ctrl+C

# 清理
clear_cache.bat

# 重启
启动ClassAudio.bat
```

### 预防措施
- 定期查看日志
- 及时清理缓存
- 避免修改核心代码

---

## 连接断开问题

### 症状
- WebSocket 显示"未连接"或"连接断开"
- 字幕突然停止更新
- 浏览器控制台显示 WebSocket 错误

### 排查步骤

1. **检查网络连接**
   - 确认后端服务正在运行
   - 访问 `http://localhost:8000/health`

2. **查看浏览器控制台**
   - 按 F12 打开开发者工具
   - 查看 Console 标签的错误信息
   - 查看 Network 标签的 WebSocket 连接

3. **检查后端日志**
   ```bash
   tail -f logs/audio_service.log
   ```

### 解决方案

#### 方案 1：心跳机制（已实现）
系统已自动配置：
- 每 30 秒发送一次心跳
- 超时自动重连
- 最多重连 5 次

#### 方案 2：手动重连
在浏览器中：
1. 刷新页面（F5）
2. 重新点击"开始录音"

#### 方案 3：检查防火墙
确保端口 8000 和 8080 未被阻止：
```bash
# Windows 防火墙
netsh advfirewall firewall add rule name="ClassAudio" dir=in action=allow protocol=TCP localport=8000,8080
```

### 优化建议
- 使用稳定的网络环境
- 避免长时间空闲（超过 10 分钟）
- 定期保存笔记

---

## 专业词汇生成失败

### 症状
- 点击"设置主题"后一直显示"生成中..."
- Toast 提示"设置失败"
- 浏览器控制台显示 500 错误

### 排查步骤

1. **检查网络连接**
   - LLM API 需要网络访问
   - 尝试 ping API 服务器

2. **查看后端日志**
   ```bash
   tail -f logs/audio_service.log
   ```
   查找"Failed to generate keywords"

3. **检查 API 密钥**
   - 打开 `src/config.py`
   - 确认 `DEEPSEEK_API_KEY` 有效

### 解决方案

#### 方案 1：检查 API 配置
```python
# src/config.py
DEEPSEEK_API_KEY = "your-actual-api-key"
DEEPSEEK_BASE_URL = "https://ark.cn-beijing.volces.com/api/v3"
```

#### 方案 2：测试 LLM 连接
```bash
jupyter notebook keywords.ipynb
```
运行单元格测试生成。

#### 方案 3：使用默认词汇
如果 LLM 不可用，系统会自动使用 `DEFAULT_PROF_WORDS`，可以正常录音。

### 替代方案
不设置主题也可以正常使用，只是转写准确度可能略低。

---

## 代码修改不生效

### 症状
- 修改 Python 代码后重启，但行为未变化
- 错误信息显示旧代码的行号
- 配置修改不生效

### 原因
Python 会将 `.py` 文件编译为 `.pyc` 字节码缓存在 `__pycache__/` 目录中。

### 解决方案

#### 方案 1：使用清理脚本（推荐）
```bash
clear_cache.bat
```

#### 方案 2：手动删除缓存
```bash
# Windows
for /d /r %%i in (__pycache__) do rd /s /q "%%i"
del /s /q *.pyc

# Linux/Mac
find . -type d -name __pycache__ -exec rm -rf {} +
find . -name "*.pyc" -delete
```

#### 方案 3：强制重新编译
```bash
python -B run.py  # -B 参数禁用字节码缓存
```

### 预防措施
- 修改代码后总是运行 `clear_cache.bat`
- `启动ClassAudio.bat` 已自动包含缓存清理

---

## 音频捕获问题

### 症状
- 点击"开始录音"后无反应
- VAD 日志显示"No speech detected"
- 麦克风无输入

### 排查步骤

1. **检查麦克风权限**
   - Windows：设置 → 隐私 → 麦克风
   - 确保允许应用访问麦克风

2. **测试麦克风**
   ```bash
   # 使用系统录音工具测试
   # Windows: 录音机
   # Mac: QuickTime
   ```

3. **检查 PyAudio 安装**
   ```bash
   python -c "import pyaudio; p=pyaudio.PyAudio(); print(p.get_default_input_device_info())"
   ```

### 解决方案

#### 方案 1：更换麦克风设备
```python
# src/config.py
# 添加设备索引（如果需要）
AUDIO_DEVICE_INDEX = 0  # 尝试不同的索引
```

#### 方案 2：调整 VAD 阈值
```python
# src/config.py
VAD_THRESHOLD = 0.3  # 降低阈值（默认 0.5）
```

#### 方案 3：重装 PyAudio
```bash
pip uninstall pyaudio
pip install pyaudio
```

---

## 模型加载失败

### 症状
- 启动时提示"Failed to initialize Audio Service"
- 日志显示"Model not found"
- 转写功能完全不可用

### 排查步骤

1. **检查模型文件**
   ```bash
   ls data/models/
   ls data/vad/
   ```

2. **查看启动日志**
   ```bash
   tail -20 logs/audio_service.log
   ```

3. **检查磁盘空间**
   ```bash
   df -h  # Linux/Mac
   # Windows: 文件资源管理器查看
   ```

### 解决方案

#### 方案 1：重新下载模型
```python
# 运行模型下载脚本（需要自己实现）
# 或手动从 Hugging Face 下载
```

#### 方案 2：检查路径配置
```python
# src/config.py
MODEL_DIR_FINAL = os.path.join(
    DATA_DIR,
    "models",
    "models--Systran--faster-whisper-medium.en",
    "snapshots",
    "a29b04bd15381511a9af671baec01072039215e3"
)
```
确保路径正确。

#### 方案 3：使用较小模型
如果显存不足，切换到更小的模型：
```python
# src/config.py
MODEL_DIR_FINAL = os.path.join(DATA_DIR, "models", "faster-whisper-small.en")
COMPUTE_TYPE_FINAL = "int8"  # 降低精度
```

---

## 日志查看技巧

### 实时查看
```bash
python view_logs.py
```

### 查看特定日志
```bash
# 查看最新 50 行
tail -50 logs/transcriber.log

# 实时监控
tail -f logs/vad.log

# 搜索错误
grep ERROR logs/*.log
```

### 日志级别
- **DEBUG：** 详细技术信息
- **INFO：** 关键事件
- **ERROR：** 异常和错误

### 清理日志
```bash
# 删除旧日志
rm logs/*.log

# 或者轮转（保留备份）
mv logs/transcriber.log logs/transcriber.log.old
```

---

## 性能优化

### 转写延迟高
1. **使用 GPU**
   ```python
   # src/config.py
   DEVICE = "cuda"  # 而非 "cpu"
   COMPUTE_TYPE_FINAL = "float16"  # GPU 加速
   ```

2. **调整 Beam Size**
   ```python
   BEAM_SIZE = 4  # 降低搜索宽度（默认 8）
   ```

3. **减少 Partial 更新频率**
   ```python
   PARTIAL_UPDATE_MS = 500  # 增加间隔（默认 300）
   ```

### 内存占用高
1. **限制队列大小**
   ```python
   AUDIO_Q_MAX = 200  # 降低队列大小（默认 300）
   ```

2. **使用 int8 精度**
   ```python
   COMPUTE_TYPE_FINAL = "int8"  # 降低精度
   ```

---

## 常见错误代码

### HTTP 500
**原因：** 后端内部错误
**解决：** 查看后端日志，检查配置

### WebSocket 1006
**原因：** 连接异常关闭
**解决：** 检查网络，刷新页面

### TypeError: NoneType
**原因：** 变量为 None 但未处理
**解决：** 清理缓存，检查代码

### FileNotFoundError
**原因：** 模型文件缺失
**解决：** 下载模型，检查路径

---

## 获取帮助

### 自助排查
1. 查看日志：`python view_logs.py`
2. 阅读本文档
3. 检查浏览器控制台

### 报告问题
提供以下信息：
- 问题描述和重现步骤
- 相关日志（最新 50 行）
- 系统环境（Python 版本、操作系统）
- 浏览器和版本

### 联系支持
- **GitHub Issues：** 提交问题
- **文档：** 查看 `docs/` 目录

---

**提示：** 大多数问题可通过清理缓存和重启服务解决。
